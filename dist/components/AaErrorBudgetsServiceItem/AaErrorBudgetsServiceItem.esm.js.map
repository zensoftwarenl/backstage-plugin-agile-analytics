{"version":3,"file":"AaErrorBudgetsServiceItem.esm.js","sources":["../../../src/components/AaErrorBudgetsServiceItem/AaErrorBudgetsServiceItem.tsx"],"sourcesContent":["/* eslint-disable no-console */\r\nimport { InfoCard, Progress } from '@backstage/core-components';\r\nimport {\r\n  Service,\r\n\r\n  SingleServiceDataResponse,\r\n  SloHistoryDataResponse,\r\n  Timeperiod,\r\n} from '../../api/types';\r\nimport { Typography } from '@material-ui/core';\r\nimport { configApiRef, useApi } from '@backstage/core-plugin-api';\r\nimport { agileAnalyticsApiRef } from '../../api';\r\nimport useAsync from 'react-use/lib/useAsync';\r\nimport Alert from '@material-ui/lab/Alert';\r\nimport { AaErrorBudgetsChart } from '../AaErrorBudgetsChart';\r\n\r\nexport const AaErrorBudgetsServiceItem = ({\r\n  timeperiod,\r\n  service,\r\n  deploymentsList,\r\n  orgHash,\r\n  apiKey,\r\n}: {\r\n  timeperiod: Timeperiod;\r\n  service: Service;\r\n  deploymentsList: any[];\r\n  orgHash: string;\r\n  apiKey: string;\r\n}) => {\r\n  const api = useApi(agileAnalyticsApiRef);\r\n  const { date_start: dateTimeStart, date_end: dateTimeEnd } = timeperiod;\r\n\r\n  const singleServicesState =\r\n    useAsync(async (): Promise<SingleServiceDataResponse> => {\r\n      const response = await api.getSingleServiceData({\r\n        orgHash,\r\n        apiKey,\r\n        serviceName: service.service,\r\n      });\r\n      return response;\r\n    }, [service]);\r\n\r\n  const chartDataState = useAsync(async (): Promise<SloHistoryDataResponse> => {\r\n    let response: { data?: any; status: number; error: string } = {\r\n      data: null,\r\n      status: 204,\r\n      error: '',\r\n    };\r\n\r\n    if (singleServicesState?.value?.features?.length) {\r\n      try {\r\n        const values = await Promise.allSettled(\r\n          singleServicesState?.value?.features.map(featureItem =>\r\n            api.getErrorBudgetChartData({\r\n              orgHash,\r\n              apiKey,\r\n              serviceName: service.service,\r\n              feature: featureItem.feature_name,\r\n              date_start: dateTimeStart,\r\n              date_end: dateTimeEnd,\r\n              step_size: '24 hours',\r\n            }),\r\n          ),\r\n        );\r\n\r\n        if (values.length) {\r\n          if (!values.find(value => value.status === 'fulfilled')) {\r\n            response = {\r\n              ...response,\r\n              status: 404,\r\n              error: 'error',\r\n            };\r\n          } else {\r\n            let status = 200;\r\n\r\n            if (\r\n              !values.find(\r\n                value =>\r\n                  value.status === 'fulfilled' && value.value.status !== 204,\r\n              )\r\n            ) {\r\n              status = 204;\r\n            }\r\n\r\n            response = {\r\n              ...response,\r\n              data: values\r\n                .filter(value => value.status === 'fulfilled')\r\n                .map(value => (value.value ? value.value : undefined))\r\n                .filter(value => value !== undefined),\r\n              status: 200,\r\n            };\r\n          }\r\n        }\r\n      } catch (err) {\r\n        console.log(err);\r\n      }\r\n    }\r\n    return response;\r\n  }, [singleServicesState?.value]);\r\n\r\n  if (singleServicesState?.loading || chartDataState?.loading) {\r\n    return <Progress />;\r\n  } else if (singleServicesState?.error || chartDataState?.error) {\r\n    return (\r\n      <Alert severity=\"error\">\r\n        {singleServicesState?.error?.message ?? chartDataState?.error?.message}\r\n      </Alert>\r\n    );\r\n  } else if (!singleServicesState?.value || !chartDataState?.value) {\r\n    return <Typography component=\"p\">No data</Typography>;\r\n  }\r\n\r\n  return (\r\n    <InfoCard\r\n      title={`Service: ${service?.service}`}\r\n      subheader={`Operational dashboard URL: ${service?.url}`}\r\n    >\r\n      {!singleServicesState?.value?.features?.length ? (\r\n        <Typography component=\"p\">No Error budgets data</Typography>\r\n      ) : (\r\n        <AaErrorBudgetsChart\r\n          timeperiod={timeperiod}\r\n          selectedService={service?.service}\r\n          serviceState={singleServicesState?.value}\r\n          step=\"24 hours\"\r\n          chartState={chartDataState?.value}\r\n          deploymentsList={deploymentsList}\r\n        />\r\n      )}\r\n    </InfoCard>\r\n  );\r\n};\r\n"],"names":[],"mappings":"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"}