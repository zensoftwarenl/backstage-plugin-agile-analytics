{"version":3,"file":"AaKudosPage.esm.js","sources":["../../../src/components/AaKudosPage/AaKudosPage.tsx"],"sourcesContent":["/* eslint-disable no-console */\r\nimport React, { useState, useEffect } from 'react';\r\nimport { Progress } from '@backstage/core-components';\r\nimport {\r\n  EmojiDataResponse,\r\n  TeamKudosLeaderBoardResponse,\r\n  TeamsDataResponse,\r\n  Timeperiod,\r\n  User,\r\n  WorkspacesDataResponse,\r\n} from '../../api/types';\r\nimport { Grid, Typography } from '@material-ui/core';\r\nimport { configApiRef, useApi } from '@backstage/core-plugin-api';\r\nimport { agileAnalyticsApiRef } from '../../api';\r\nimport useAsync from 'react-use/lib/useAsync';\r\nimport Alert from '@material-ui/lab/Alert';\r\nimport { AaKudosLast } from '../AaKudosLast';\r\nimport { AaKudosTotal } from '../AaKudosTotal';\r\nimport { AaKudosLeaderboard } from '../AaKudosLeaderboard';\r\nimport { AaKudosChart } from '../AaKudosChart';\r\n\r\nexport const AaKudosPage = ({ timeperiod }: { timeperiod: Timeperiod }) => {\r\n  const api = useApi(agileAnalyticsApiRef);\r\n  const config = useApi(configApiRef);\r\n  const orgHash = config.getString('agileAnalytics.orgHash');\r\n  const apiKey = config.getString('agileAnalytics.apiKey');\r\n\r\n  const { date_start, date_end } = timeperiod;\r\n\r\n  const teamsDataState = useAsync(async (): Promise<TeamsDataResponse> => {\r\n    const response = await api.getTeamsData({\r\n      orgHash,\r\n      apiKey,\r\n    });\r\n    return response;\r\n  }, []);\r\n\r\n  const workspacesState =\r\n    useAsync(async (): Promise<WorkspacesDataResponse> => {\r\n      const response = await api.getWorkspacesData({\r\n        orgHash,\r\n        apiKey,\r\n      });\r\n      return response;\r\n    }, []);\r\n\r\n  const emojiState = useAsync(async (): Promise<EmojiDataResponse> => {\r\n    const response = await api.getEmoji({\r\n      orgHash,\r\n      apiKey,\r\n    });\r\n    return response;\r\n  }, [timeperiod]);\r\n\r\n  const [activeTeam, setActiveTeam] = useState<string | null>(null);\r\n\r\n  const kudosLeaderBoardState =\r\n    useAsync(async (): Promise<TeamKudosLeaderBoardResponse> => {\r\n      const response = await api.getTeamKudosLeaderBoard({\r\n        orgHash,\r\n        apiKey,\r\n        team: activeTeam ? activeTeam : 'all',\r\n        date_end,\r\n        date_start,\r\n      });\r\n      return response;\r\n    }, [activeTeam, timeperiod]);\r\n\r\n  const [localTeamsState, setLocalTeamsState] = useState(() => {\r\n    if (teamsDataState?.value) {\r\n      return {\r\n        ...teamsDataState,\r\n        data: [\r\n          ...(teamsDataState?.value || null),\r\n          {\r\n            team_hash: 'all',\r\n            team_name: 'Overall',\r\n            users_in_team: [],\r\n          },\r\n        ],\r\n      };\r\n    }\r\n    return {\r\n      ...teamsDataState,\r\n      data: [\r\n        {\r\n          team_hash: 'all',\r\n          team_name: 'Overall',\r\n          users_in_team: [],\r\n        },\r\n      ],\r\n    };\r\n  });\r\n\r\n  const orgUsersState = useAsync(async (): Promise<any> => {\r\n    let response: { data?: any; status: number; error: string } = {\r\n      data: null,\r\n      status: 204,\r\n      error: '',\r\n    };\r\n\r\n    const usersList = await api.getOrgUsersData({\r\n      orgHash,\r\n      apiKey,\r\n    });\r\n\r\n    if (usersList?.length) {\r\n      try {\r\n        const values: any = await Promise.allSettled(\r\n          usersList.map((user: User) => {\r\n            if (user?.photo && !user?.photo?.startsWith('https://')) {\r\n              const userPic = api.getUserPic({\r\n                orgHash,\r\n                apiKey,\r\n                url: user?.photo,\r\n              });\r\n              return userPic;\r\n            }\r\n\r\n            return user?.photo;\r\n          }),\r\n        );\r\n\r\n        const usersListWithUserPics = usersList?.map((user, i: number) => {\r\n          return { ...user, photo: values[i]?.value };\r\n        });\r\n\r\n        response = { data: usersListWithUserPics, status: 200, error: '' };\r\n      } catch (err) {\r\n        console.log(err);\r\n      }\r\n    }\r\n\r\n    return response;\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    if (!teamsDataState?.value) {\r\n      setActiveTeam('all');\r\n\r\n      setLocalTeamsState(() => {\r\n        return {\r\n          ...(teamsDataState || null),\r\n\r\n          data: [\r\n            {\r\n              team_hash: 'all',\r\n              team_name: 'Overall',\r\n              users_in_team: [],\r\n            },\r\n          ],\r\n        };\r\n      });\r\n    } else {\r\n      setActiveTeam('all');\r\n\r\n      setLocalTeamsState(() => {\r\n        return {\r\n          ...(teamsDataState || null),\r\n          data: [\r\n            {\r\n              team_hash: 'all',\r\n              team_name: 'Overall',\r\n              users_in_team: [],\r\n            },\r\n            ...(teamsDataState?.value || []),\r\n          ],\r\n        };\r\n      });\r\n    }\r\n  }, [teamsDataState?.value, workspacesState?.value]);\r\n\r\n  if (\r\n    teamsDataState?.loading ||\r\n    workspacesState?.loading ||\r\n    orgUsersState?.loading\r\n  ) {\r\n    return <Progress />;\r\n  } else if (\r\n    teamsDataState?.error ||\r\n    workspacesState?.error ||\r\n    orgUsersState?.error\r\n  ) {\r\n    return (\r\n      <Alert severity=\"error\">\r\n        {teamsDataState?.error?.message\r\n          ? teamsDataState?.error.message\r\n          : workspacesState?.error?.message\r\n          ? workspacesState?.error?.message\r\n          : orgUsersState?.error?.message}\r\n      </Alert>\r\n    );\r\n  } else if (!localTeamsState?.data?.length) {\r\n    return <Typography component=\"p\">No data</Typography>;\r\n  } else if (!workspacesState?.value) {\r\n    return <Typography component=\"p\">Slack is not connected</Typography>;\r\n  } else if (!orgUsersState?.value) {\r\n    return <Typography component=\"p\">No users in the organisation</Typography>;\r\n  }\r\n\r\n  return (\r\n    <Grid container spacing={3} alignItems=\"stretch\" >\r\n      <Grid item xs={4}>\r\n        <AaKudosLast\r\n          users={orgUsersState?.value}\r\n          kudos={emojiState?.value ? emojiState?.value : []}\r\n          kudosLeaderBoard={kudosLeaderBoardState?.value}\r\n        />\r\n      </Grid>\r\n      <Grid item xs={4}>\r\n        <AaKudosTotal\r\n          users={orgUsersState?.value}\r\n          kudos={emojiState?.value ? emojiState?.value : []}\r\n          kudosLeaderBoard={kudosLeaderBoardState?.value}\r\n        />\r\n      </Grid>\r\n      <Grid item xs={4}>\r\n        <AaKudosLeaderboard\r\n          localTeamsState={\r\n            localTeamsState?.data?.length ? localTeamsState?.data : []\r\n          }\r\n          selectedTeam={activeTeam}\r\n          setActiveTeam={setActiveTeam}\r\n          teamsState={\r\n            teamsDataState?.value?.length ? teamsDataState?.value : []\r\n          }\r\n          users={orgUsersState?.value}\r\n          kudos={emojiState?.value ? emojiState?.value : []}\r\n          kudosLeaderBoard={kudosLeaderBoardState?.value}\r\n          timeperiod={timeperiod}\r\n        />\r\n      </Grid>\r\n      <Grid item xs={12}>\r\n        <AaKudosChart\r\n          timeperiod={timeperiod}\r\n          users={orgUsersState?.value}\r\n          activeTeam={activeTeam ? activeTeam : 'all'}\r\n        />\r\n      </Grid>\r\n    </Grid>\r\n  );\r\n};\r\n"],"names":[],"mappings":"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"}